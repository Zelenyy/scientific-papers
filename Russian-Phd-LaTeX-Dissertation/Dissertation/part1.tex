\chapter{Монте-Карло моделирование с помощью транспортного кода GEANT4}\label{ch:theory}

\section{Монте-Карло моделирование с GEANT4
}\label{sec:theory/geant4}
GEANT4~\cite{Geant2006, Geant2016, Geant2003, collaboration2016physics, collaboration2012geant4} это транспортный код и набор инструментов на языке С++ для Монте-Карло моделирования прохождения элементарных частиц через вещество. Фактически GEANT4 являет собой фундамент для написания программ для моделирования процессов в физике высоких энергий и физики элементарных частиц. Для этого GEANT4 предоставляет пользователю наборы классов которые модно разделить по нескольким категориям: 
\begin{itemize}
    \item Классы управление сеансом и событиями --- предоставляют инструментарий для подключения генераторов первичных событий и управления событие и наборами событий, передают сгенерированные первичные и рожденные вторичные частицы в систему трекинга частиц.
    \item Классы трекинга частиц --- обеспечивают Монте-Карло расчет прохождения элементарных частиц в соответствии с заданной модель физических взаимодействий. Определяет такие понятия как трек частицы --- ломанную линию, задающую траекторию движения частицы и шаг частицы --- движение по звену этой линии. 
    \item Классы геометрического движка и физических полей --- позволяют определить геометрическую модель симуляции, а так же учесть в моделировании влияние различных полей (в данной работе, это используется для расчетов движения релятивистских электронов в электрическом поле грозовых облаков, см. раздел~\ref{sec:theory/efield}).
    \item Классы для определить частиц и материалов --- позволяют описать параметры элементарных частиц, свойства изотопов, химических элементов и используемых материалов.
    \item Классы физических моделей и процессов --- позволяют задать необходимые в моделировании физические взаимодействия элементарных частиц с веществом.
    \item Классы для обработки попаданий частиц в детекторы и дальнейшей оцифровки сигнала --- позволяют геометрическим объемам моделировать работу  детектор, включая возможность перейти от взаимодействия частицы с объемом к генерации и обработке цифрового сигнала.
    \item Классы пользовательского интерфейса --- обеспечивают взаимодействие с пользователем через графический интерфейс, а также взаимодействие с внешними инструментами.
    \item Классы для визуализации --- предоставляют полный набор инструментов для визуализации геометрической модели, траекторий частиц и энерговыделения в детекторах.Например, эти классы использовались для создания некоторых иллюстраций в данной работе.
\end{itemize}
Для создания собственного моделирования с помощью GEANT4 пользователю надо реализовать наследников ряда базовых классов и передать их в объект-менеджер симуляции. Пользователю надо реализовать три обязательных класса и опционально он может реализовать ряд дополнительных классов. К обязательны для реализации классам относятся: 
\begin{enumerate}
    \item  Класс определяющий геометрическую модель эксперимента. Геометрия в GEANT4 основана на использовании геометрических примитивов (в том числе полученных путем использования операция логического сложения/вычитания). Пользователю необходимо задать иерархию логических и физических объемов. Логический объем хранит информацию о свойствах объемах, таких как задающий форму объема примитив, распределение напряженности поля в объеме, является ли объем детектором. Физический объем определяет трансляцию и ориентацию объема в пространстве. Если объем является детектирующим, то должен быть задан класс определяющий логику работы детектора, пользователь может выбрать один из предопределенных классов или реализовать свой.Так же в случае если объем находится в поле, должны быть определены класс задающий распределения поля и ряд классов решающих уравнение движения частицы в поле.
    \item Класс определяющий физическую модель эксперимента, которая основана на концепции физического листа как набора процессов, каждый  из процессов описывает конкретное взаимодействие и представляет собой набор моделей вычисляющих параметры взаимодействия на основе параметров частицы. Использование нескольких моделей для описания одного процесса позволяет повысить точность расчетов, например, за счет выбора модели более точной в нужном диапазоне энергий, а также позволяет комбинировать теоретические модели, с моделями построенными на аппроксимации экспериментальных данных. Пользователя может определить или свои модели, или сконструировать физический лист из отдельных моделей или наборов моделей поставляемых разработчиками GEANT4 или другими исследователями. Так же пользователь может задать лимиты на параметры моделирования, например определив предельный шаг для каждого вещества.
    \item Класс генерирующий первичную частицу. Пользователь может использовать для задания первичной частицы, или поставляемые классы для генерации угловых, пространственных и энергетических распределений, или написать собственную логику генерации, или подключить какой-либо внешний генератор.  
\end{enumerate}
Для большего контроля над моделирование и вывода нужны результатов пользователь может реализовать опциональные классы, которые в терминологии GEANT4 называются \textit{actions}, далее мы приведем описание таких классов.\\
\textit{Run actions} --- объекты этого класса вызываются в начале и конце каждого сеанса, поэтому код этих действий обычно связан с  подготовкой к симуляции (сброс системы сбора данных, создание файлов) и обобщение результата симуляции, сохранения результатов насчитанных по совокупности событий, например результирующих гистограмм.\\
\textit{Event actions} ---  объекты этого класса вызываются в начале и конце каждого события,  поэтому код этих действий обычно связан с  подготовкой к симуляции отдельного события и обработкой итогов этого события, сохранения результатов полученных в отдельном событии или передача данных для гистограммирования. \\
\textit{Stacking actions} --- объекты этого класса связанны с управление стеком моделируемых в событии частиц (следует отметить что использование слова стек, не совсем корректно поскольку реальная реализация использует такую структуру данных как очередь, но следую терминологии GEANT4 мы будет использовать его). Управление стеком осуществляется как из соображений связанных с физикой моделирования, так и для улучшения производительности (в частности в данной работе мы будет использовать для оптимизации вычислений в главе ~\ref{ch:thunderstorm}, см. раздел). Данный действия позволяют распределять первичный и вторичные частиц по отдельным стекам определяющим порядок вычислений, или же вообще исключить новую частицу из дальнейшего моделирования. Каждый стек имеет приоритет исполнения, доступны три типа стека: срочный стек  --- когда GEANT4 заканчивает трекинг частицы, то следующая частица будет взята из этого стека, стеки ожидания --- набор стеков (по умолчанию он один, но дополнительный стеки с более низким приоритетом могу быть добавлены пользователем), частицы из стека ожидания моделируются только при освобождении более приоритетных стеков, стек для переброса частицы в следующее событие --- специальный стек который хранит частицы, который моделирование которых по мнению пользователя нужно провести в следующем событии. Так же данный класс позволяет исключать из моделирования те  частицы, физические параметры которых не удовлетворяют необходимым условиям.\\
\textit{Tracking actions} --- объекты этого класса связанны с обработкой трека частицы, в частности они вызываются перед началом и в конце моделирования трека отдельной частицы, что например позволяет получит информацию о начальной и конечной точке трека частицы, и её параметрах в этой точке.\\
\textit{Stepping actions} --- объекты этого класса связанны с пошаговой обработкой трека частицы, они вызываются в конце каждого шага совершенного частицей, что позволяет  получать детальную информацию от треке частицы и об энерговыделении в веществе на каждом шаге, так же задать определить дополнительные условия для остановки трекинга частицы.\\
Следует отметить что если пользователь прекратил трекинг частицы через один из перечисленным способов, то остаток кинетической энергии частицы не учитывается при расчетах энерговыделения в веществе (в отличии от остановки частицы "естественным" образом, через физическую модель).\\
Наиболее существенным моментом при моделировании в GEANT4 является создание физического листа, именно от правильного выбора используемых моделей и зависит корректность результата, нужно убедится что в физический лист включены
все необходимые процессы, а модели в этих процессах обхватывают весь диапазон потенциально возможных параметров частиц. Поэтому далее в этой главе  приведено краткое описание актуальных для данной работы взаимодействий и приведен обзор физических листов с точки зрения актуальности для данной работы.

\section{Прохождение фотонов и заряженных частиц через вещество}\label{sec:theory/propagation}
Для того чтобы понять какие взаимодействия актуальны для моделирования, нужно определить диапазон энергий и тип частиц участвующих в моделировании. В работе автор будет использовать моделирование для проектирования двух детекторов (орбитального детектора и сканера транспортных контейнеров) и исследования лавин релятивистских убегающих электронов. Диапазон энергий и тип частиц для  орбитальный детектор определяется предъявленными требованиями (см. раздел~\ref{subsec:detectors/construction}) --- он должен регистрировать электроны (от 1 до 10 МэВ) и протоны (от 10 до 100 МэВ), для сканера определяется конструктивными особенностями (см. раздел~\ref{sec:detectors/scanners}) --- источником первичных электронов служат ускоритель разгоняющих их до энергий в 8-10 МэВ, а нижний порог энергий определяется порогом регистрации и составляет примерно 300 КэВ. Что касается убегающих электронов, основываясь на приведённых в главе~\ref{ch:thunderstorm} обзорах экспериментальных данных и существующих моделей, нам интересны электроны, позитроны, гамма-кванты и нейтроны до энергий несколько десятков МэВ.

Кратко опишем какие физические процессы происходят с перечисленными частицами в интересующем нас диапазоне энергий от нескольких КэВ до 150 МэВ~\cite{bespalov2008, kolchuzkin1978, nemec1975,heitler1984quantum, collaboration2016physics}.

Электромагнитные взаимодействие фотонов описывается пятью процессами: рассеяние как электромагнитной волны, комптоновское рассеяние, фотоэффект, рождение электрон-позитронных пар и фотоядерные реакции. Рассеяние как электромагнитной волны это совокупность процессов при которых рассеяние происходит на одиночных и связанных электронах, группах зарядов и на атомных ядрах, характеризующееся тем что длина волны фотона больше или сравнима в размером системы, и по этому описание таких явлений происходит с точки зрения волновой природы света, сечение рассеяния в этом случае обычно растёт по мере уменьшения длинны волны фотона, достигает максимального значения при частоте соответствующей собственной частоте рассеивающего центра и далее спадает. Этим типом рассеяния мы можем пренебречь по сравнению с вкладом следующих трех процессов, поскольку нас интересуют фотоны начиная с рентгеновского диапазона, и для них сечения рассеяния на атоме мало, так как длина волны таких фотонов уже меньше размеров атома, а сечение рассеяния на ядре мало само по себе даже в точке максимума. Следующие три процесса являются основными для нас. Сильно зависящими от зарядового числа $Z$ являются фотоэффект($\sim Z^5$) и конверсия в пары ($\sim Z^4$), Комптон-эффект менее($\sim Z^2$), что как будет показано в разделе~\ref{sec:detectors/scanners} можно использовать для разработки гамма-сканера химического состава, Что касается зависимости от энергии, на малых энергия доминирует фотоэффект, затем начиная с некоторой энергии (порядка 0.1~МэВ для легких атомов и 0.5~МэВ для тяжелых) основную роль играет Комптон-эффект, наконец начиная с энергий порядка нескольких МэВ для тяжелых металлов и десятков МэВ для легких, начинает доминировать рождение электрон-позитронных пар. Следует отметит резонансный характер сечения фотоэффекта, в том случае когда энергия фотона близка к энергии атомных оболочек, так же пороговый характер процесса рождения электрон-позитронных пар (энергия фотона от 1.024 МэВ для рождения в поле ядра и 2.048 МэВ для рождения в поле электрона). Фотоядерные реакции (ядерный фотоэффект) представляют собой возбуждение ядра за счет поглощения гамма-кванта и дальнейшей возврат ядра в невозбужденное состояние за счет испускания одного или нескольких нуклонов.Все фотоядерные реакции являются пороговыми (пороговая энергия порядка 6~--~8 МэВ для большинства ядер) и имеют сходную зависимость сечения от энергии, главной особенностью которой является большой максимум шириной несколько МэВ называемый гигантским резонансом. Однако, не смотря на резонансный характер реакций их сечение на порядки меньше суммарного сечения предыдущих трёх процессов и поэтому мы пренебрежем ими, за исключением расчетов в разделе~\ref{sec:thunderstorm/neutron}, где требуется смоделировать рождение нейтронов.

Для заряженных частиц таких как протоны и электроны мы можем выделить следующие группы процессов: упругое рассеяние, неупругие столкновения со связанными атомными электронами, излучение и ядерные взаимодействия. 

К излучающих процессам заряженных частиц относятся излучение Вавилова-Черенкова, переходное, тормозное и аннигиляционное излучение. 
Излучение Вавилова-Черенкова, представляет собой излучение среды поляризованной в следствии  прохождение через неё заряженной частиц со скоростью превышающей скорость света в веществе. Как следствие это излучение пороговое (например, порог для энергии электронов в воздухе порядка 20 МэВ, а в воде 0.26 МэВ), излучается оптический фотоны, а вклад в ионизационные потери составляет равен $\sim 0.1 \%$. Поэтому мы пренебрежем этим излучением. Переходное излучение возникает при прохождении заряженной частицей оптически неоднородной среды. Мы можем пренебречь этим процессом поскольку либо  мы будет работать с достаточно однородными оптическими средами, либо вклад этого процесса в потери энергии частиц или рождение рентгеновского излучения мал в нашем диапазоне энергий. Тормозное излучение является одним из главных для наше работы процессов, оно обеспечивает рождение гамма-квантов лавинами релятивистских убегающих электронов, является источником облучения в сканере транспортных контейнеров, обеспечивает основной вклад в потери высокоэнергичных электронов. Типовой спектр этого излучения будет приведен в разделе~\ref{sec:detectors/scanners}. Аннигиляционное излучение в нашей работе возникает только при аннигиляции позитронов и позволяет косвенно оценить как много их производится, что в свою очередь можно связать с химическим составом вещества (в следствии упомянутой выше сильной зависимости сечения рождения пар от зарядового числа), а использовать при обзоре экспериментальных результатов по регистрации спектров гамма-излучения от грозовых облаков. 

Упругое рассеяние зараженных частиц происходит в кулоновском поле атомных электронов и атомного ядра. Это один из основных процессов влияющих на изменение траектории заряженных частиц, причем за счет квадратичной зависимости от отношения масс налетающей и покоящейся частицы, на электроны он влияет значительно сильнее чем на протоны.  Это хорошо заметно в случаях когда важна угловая расходимость пучка, например при разработке орбитального детектора протонов и электронов она влияет на выбор ширины детектора, а также определяет радиальные размеры лавин убегающих электронов. Так же в зависимости от соотношения толщины слоя вещества и длинны свободного пробега частицы, упругие процессы могут рассматривать как одиночные рассеяния (в случае больших длин пробега, как у протонов), так и как сразу последовательность столкновений, рассчитывая конечное распределение (в случае малых длин пробега,например для электронов используется распределение Гоудсмита-Саундерсона). Так же следует отметить что для электронов и позитронов даже малых энергий важен учет релятивистских эффектов и взаимодействия спинов частиц со спином ядра (коррекция Мотта). 

Неупругие столкновения со связанными атомными электронами определяют ионизационные потери заряженных частиц. Именно за счет потерь на ионизацию происходит регистрация частиц в полупроводниковых и сцинтилляционных детекторах, характерный для протонов максимум потерь в конце траектории (пик Брэгга), позволяет дифференцировать с электронами, а наличие области с минимальными потерями в формуле Бета-Блоха создает условия для существования убегающих электронов.

Вкладом ядерных взаимодействий на прохождение протонов мы пренебрежем, поскольку при измерении интегральных ионизационных потерь он не существенен, а при регистрации отдельных частиц, события в которых произошла ядерная реакция могу быть отфильтрованы (см. обсуждение~\ref{sec:detectors/satellite}). 

\section{Электромагнитные модели в GEANT4 }\label{sec:theory/models}

GEANT4 поставляет ряд готовых конструкторов задающих набор физических процессов и моделей, и нам нужно определить какие конструкторы нам необходимо использовать что бы учесть процессы описанные в разделе~\ref{sec:theory/propagation}.

Фотоядерные реакции можно подключить используя конструктор \textit{G4EmExtraPhysics}, этот конструктор мы будем использовать только при моделировании~\ref{sec:thunderstorm/neutron}.

%EmStandartOptx, PENELOPA, Livermore
%
%\subsection{PENELOPA}
%Для расчета сечений используется и экспериментальные данные, и аналитические формулы.Описывает процессы для фотонов, электронов и позитронов: рэлеевское рассеяние, комптон-эффект, тормозное излучение, фотоэффект, рождение электрон-позитронных пар гаммой, ионизация (в разработке), аннигиляция позитрона (в разработке)
%Рекомендованные энергетические пределы: 100 эВ – 1 ГэВ
%Рассматриваются тормозное излучение и ионизация для позитрона, а также его аннигиляция
%
%\subsection{Livermore}
%Сечение рассчитывается на основе экспериментальных данных
%Описывает процессы для фотонов, электронов, ионов и адронов: рэлеевское рассеяние, комптон-эффект, тормозное излучение, фотоэффект, рождение электрон-позитронных пар гаммой, ионизация, флюоресценция, электронная эмиссия Ожэ возбужденных атомов
%Рекомендованные энергетические пределы: 250 эВ – 100 ГэВ
%
%- Рэлеевское рассеяние ~ 10 эВ
%
%- Комптон-эффект ~ 250 эВ
%
%- Тормозное излучение ~ 10 эВ
%
%- Ионизация ~ 100 эВ
%
%- Фотоэффект ~ 10 эВ
%
%- Рождение электрон-позитронных пар гаммой ~ 1 МэВ
%
%Не учитываются позитроны (кроме рождения электрон-позитронных пар)
%
%\subsection{}
\section{Электрическое поле в GEANT4 }\label{sec:theory/efield}
Глава ~\ref{ch:thunderstorm} посвящена моделированию лавин релятивистских убегающих электронов в электрическом поле грозовых облаков, поэтому в данном разделе описано как подключается электрическое поле в симуляции. Для включение электрического поля необходимо: 
\begin{itemize}
    \item Определить распределение поля: можно установить однородное поле с заданным вектором напряжённости или задать произвольное поле, реализовав объект который принимает координата точки и время и должен вернуть вектор напряжённости поля.
    \item Задать классы ответственные за решения уравнения движения в этом поле: класс описывающий уравнение движения, указать число переменных, класс интегрирующий уравнение движения, класс контролирующий погрешность вычислений интеграла движения и класс рассчитывающий траекторию движения( который также проводи вычисляет поправку на кривизну траектории) . В данной работе для интегрирования уравнения движения в зависимости от версии GEANT4 использовались,или класс \textit{G4ClassicalRK4} классический метод Рунге-Кутта 4-го порядка~\cite{fedorenko1994} или класс \textit{G4DormandPrince745} реализующий метод Рунге-Кутта 5-го порядка~\cite{dormand1980family}. 
    \item Зарегистрировать поле в менеджере полей и подключить этот менеджер к геометрическому объему.
\end{itemize}

Далее приводится пример кода используемого для подключения электрического поля:
\begin{lstlisting}[language=C++]
 // Задаем однородное поле
 G4ElectricField *fEMfield = new G4UniformElectricField(
        G4ThreeVector(0.0, 0.0, 200.0*(kilovolt/meter)));
 // Уравение движение учитывающее силу Кулона и силу Лоренца
 auto *equation = new G4EqMagElectricField(fEMfield);
 G4int nvar = 8;
 // Выбираем интегратор, как альтенативу можно использовать G4ClassicalRK4
 auto fStepper = new G4DormandPrince745(equation, nvar);
 auto *fieldManager = new G4FieldManager();
 // Устанавливаем менеджер полей для геометричекого объема
 fieldVolume->SetFieldManager(fieldManager, true); 
 fieldManager->SetDetectorField(fEMfield);
 G4double fMinStep = 0.01 * mm;  // Минимальный шаг
 // Контроль ошибок интегрирования
 auto integrationDriver = new G4MagInt_Driver(
        fMinStep,
        fStepper,
        fStepper->GetNumberOfVariables()
        );
 // Поиск корретной траектории движения
 auto fChordFinder = new G4ChordFinder(integrationDriver);
 fieldManager->SetChordFinder(fChordFinder);
\end{lstlisting}
