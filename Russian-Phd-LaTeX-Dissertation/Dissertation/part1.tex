\chapter{Монте-Карло моделирование с помощью транспортного кода GEANT4}\label{ch:theory}

\section{Монте-Карло моделирование с GEANT4
}\label{sec:theory/geant4}
GEANT4~\cite{Geant2006, Geant2016, Geant2003, collaboration2016physics, collaboration2012geant4} это транспортный код и набор инструментов на языке С++ для Монте-Карло моделирования прохождения элементарных частиц через вещество. Фактически GEANT4 являет собой фундамент для написания программ для моделирования процессов в физике высоких энергий и физики элементарных частиц. Для этого GEANT4 предоставляет пользователю наборы классов которые модно разделить по нескольким категориям: 
\begin{itemize}
    \item Классы управление сеансом и событиями --- предоставляют инструментарий для подключения генераторов первичных событий и управления событие и наборами событий, передают сгенерированные первичные и рожденные вторичные частицы в систему трекинга частиц.
    \item Классы трекинга частиц --- обеспечивают Монте-Карло расчет прохождения элементарных частиц в соответствии с заданной модель физических взаимодействий. Определяет такие понятия как трек частицы --- ломанную линию, задающую траекторию движения частицы и шаг частицы --- движение по звену этой линии. 
    \item Классы геометрического движка и физических полей --- позволяют определить геометрическую модель симуляции, а так же учесть в моделировании влияние различных полей (в данной работе, это используется для расчетов движения релятивистских электронов в электрическом поле грозовых облаков, см. раздел~\ref{sec:theory/efield}).
    \item Классы для определить частиц и материалов --- позволяют описать параметры элементарных частиц, свойства изотопов, химических элементов и используемых материалов.
    \item Классы физических моделей и процессов --- позволяют задать необходимые в моделировании физические взаимодействия элементарных частиц с веществом.
    \item Классы для обработки попаданий частиц в детекторы и дальнейшей оцифровки сигнала --- позволяют геометрическим объемам моделировать работу  детектор, включая возможность перейти от взаимодействия частицы с объемом к генерации и обработке цифрового сигнала.
    \item Классы пользовательского интерфейса --- обеспечивают взаимодействие с пользователем через графический интерфейс, а также взаимодействие с внешними инструментами.
    \item Классы для визуализации --- предоставляют полный набор инструментов для визуализации геометрической модели, траекторий частиц и энерговыделения в детекторах.Например, эти классы использовались для создания некоторых иллюстраций в данной работе.
\end{itemize}
Для создания собственного моделирования с помощью GEANT4 пользователю надо реализовать наследников ряда базовых классов и передать их в объект-менеджер симуляции. Пользователю надо реализовать три обязательных класса и опционально он может реализовать ряд дополнительных классов. К обязательны для реализации классам относятся: 
\begin{enumerate}
    \item  Класс определяющий геометрическую модель эксперимента. Геометрия в GEANT4 основана на использовании геометрических примитивов (в том числе полученных путем использования операция логического сложения/вычитания). Пользователю необходимо задать иерархию логических и физических объемов. Логический объем хранит информацию о свойствах объемах, таких как задающий форму объема примитив, распределение напряженности поля в объеме, является ли объем детектором. Физический объем определяет трансляцию и ориентацию объема в пространстве. Если объем является детектирующим, то должен быть задан класс определяющий логику работы детектора, пользователь может выбрать один из предопределенных классов или реализовать свой.Так же в случае если объем находится в поле, должны быть определены класс задающий распределения поля и ряд классов решающих уравнение движения частицы в поле.
    \item Класс определяющий физическую модель эксперимента, которая основана на концепции физического листа как набора процессов, каждый  из процессов описывает конкретное взаимодействие и представляет собой набор моделей вычисляющих параметры взаимодействия на основе параметров частицы. Использование нескольких моделей для описания одного процесса позволяет повысить точность расчетов, например, за счет выбора модели более точной в нужном диапазоне энергий, а также позволяет комбинировать теоретические модели, с моделями построенными на аппроксимации экспериментальных данных. Пользователя может определить или свои модели, или сконструировать физический лист из отдельных моделей или наборов моделей поставляемых разработчиками GEANT4 или другими исследователями. Так же пользователь может задать лимиты на параметры моделирования, например определив предельный шаг для каждого вещества.
    \item Класс генерирующий первичную частицу. Пользователь может использовать для задания первичной частицы, или поставляемые классы для генерации угловых, пространственных и энергетических распределений, или написать собственную логику генерации, или подключить какой-либо внешний генератор.  
\end{enumerate}
Для большего контроля над моделирование и вывода нужны результатов пользователь может реализовать опциональные классы, которые в терминологии GEANT4 называются \textit{actions}, далее мы приведем описание таких классов.\\
\textit{Run actions} --- объекты этого класса вызываются в начале и конце каждого сеанса, поэтому код этих действий обычно связан с  подготовкой к симуляции (сброс системы сбора данных, создание файлов) и обобщение результата симуляции, сохранения результатов насчитанных по совокупности событий, например результирующих гистограмм.\\
\textit{Event actions} ---  объекты этого класса вызываются в начале и конце каждого события,  поэтому код этих действий обычно связан с  подготовкой к симуляции отдельного события и обработкой итогов этого события, сохранения результатов полученных в отдельном событии или передача данных для гистограммирования. \\
\textit{Stacking actions} --- объекты этого класса связанны с управление стеком моделируемых в событии частиц (следует отметить что использование слова стек, не совсем корректно поскольку реальная реализация использует такую структуру данных как очередь, но следую терминологии GEANT4 мы будет использовать его). Управление стеком осуществляется как из соображений связанных с физикой моделирования, так и для улучшения производительности (в частности в данной работе мы будет использовать для оптимизации вычислений в главе ~\ref{ch:thunderstorm}, см. раздел). Данный действия позволяют распределять первичный и вторичные частиц по отдельным стекам определяющим порядок вычислений, или же вообще исключить новую частицу из дальнейшего моделирования. Каждый стек имеет приоритет исполнения, доступны три типа стека: срочный стек  --- когда GEANT4 заканчивает трекинг частицы, то следующая частица будет взята из этого стека, стеки ожидания --- набор стеков (по умолчанию он один, но дополнительный стеки с более низким приоритетом могу быть добавлены пользователем), частицы из стека ожидания моделируются только при освобождении более приоритетных стеков, стек для переброса частицы в следующее событие --- специальный стек который хранит частицы, который моделирование которых по мнению пользователя нужно провести в следующем событии. Так же данный класс позволяет исключать из моделирования те  частицы, физические параметры которых не удовлетворяют необходимым условиям.\\
\textit{Tracking actions} --- объекты этого класса связанны с обработкой трека частицы, в частности они вызываются перед началом и в конце моделирования трека отдельной частицы, что например позволяет получит информацию о начальной и конечной точке трека частицы, и её параметрах в этой точке.\\
\textit{Stepping actions} --- объекты этого класса связанны с пошаговой обработкой трека частицы, они вызываются в конце каждого шага совершенного частицей, что позволяет  получать детальную информацию от треке частицы и об энерговыделении в веществе на каждом шаге, так же задать определить дополнительные условия для остановки трекинга частицы.\\
Следует отметить что если пользователь прекратил трекинг частицы через один из перечисленным способов, то остаток кинетической энергии частицы не учитывается при расчетах энерговыделения в веществе (в отличии от остановки частицы "естественным" образом, через физическую модель).\\
Наиболее существенным моментом при моделировании в GEANT4 является создание физического листа, именно от правильного выбора используемых моделей и зависит корректность результата, нужно убедится что в физический лист включены
все необходимые процессы, а модели в этих процессах обхватывают весь диапазон потенциально возможных параметров частиц. Поэтому далее в этой главе  приведено краткое описание актуальных для данной работы взаимодействий и приведен обзор физических листов с точки зрения актуальности для данной работы.

\section{Прохождение фотонов и заряженных частиц через вещество}\label{sec:theory/propagation}
Для того чтобы понять какие взаимодействия актуальны для моделирования, нужно определить диапазон энергий и тип частиц участвующих в моделировании. В работе автор будет использовать моделирование для проектирования двух детекторов (орбитального детектора и сканера транспортных контейнеров) и исследования лавин релятивистских убегающих электронов. Диапазон энергий и тип частиц для  орбитальный детектор определяется предъявленным требованиям (см. раздел~\ref{subsec:detectors/construction}), он должен регистрировать электроны (от 1 до 10 МэВ) и протоны (от 10 до 100 МэВ), для сканера определяется конструктивными особенностями
Кратко опишем какие физические процессы происходят с гамма-квантами, протонами, электронами и позитронами происходят в интересующем нас диапазоне энергий до 150 МэВ. Взаимодействие гамма-квантов описывается пятью процессами: когерентное рассеяние, комптоновское рассеяние, фотоэффект, рождение электрон-позитронных пар, фотоядерные реакции. Каждый из этих процессов по своему зависит от состава среды в которой распространяются гамма-кванты, кроме того учет вклада того или иного процесса зависит от рассматриваемого диапазона энергий. Так когерентное рассеяние важно в оптическом и ультрафиолетовом диапазоне, и не дает значительного вклад в рентгеновском, а в гамма-диапазоне им можно полностью пренебречь. Следующие три процессы являются основными для нас, поскольку именно они определяют поглощение и рассеяние гамма-квантов. Фотоядерные реакции имеют меньшие сечения, а также обычно имеют высокий порог реакции, поэтому изучение их вклада актуально для больших потоков гамма-квантов с энергиями большим 8 МэВ, а также в том случае когда нам интересно возникновение нейтронной компоненты.
При рассмотрении процессов связанных с движение протонов и электронов удобно разделить эти процессы на упругие и неупругие. К неупругим процессам относятся столкновения с атомными электронами, приводящие к возбуждению и ионизации атомов и молекул, рассеяние с излучение тормозных фотонов и ядерные взаимодействия. 
Для протонов и электронов большую роль имеют процессы связанные с потерями энергии на ионизацию вещества и радиационные потери.  


%\subsection{Взаимодействие электромагнитного излучения с веществом}

~\cite{bespalov2008, kolchuzkin1978, nemec1975}

%\noindent Маркированный список:
%\begin{itemize}
%    \item Когерентное рассеяние
%    \item Комптоновское рассеяние
%    \item Фотоэффект
%    \item Эффект образования  электрон-позитронных пар
%    \item Фотоядерные реакции
%\end{itemize}

%\subsection{Упругие столкновения заряженных частиц в с веществом}

%\subsection{Неупругие столкновения заряженных частиц с веществом}

%\subsection{Излучение заряженных частиц движущихся в веществе}


  

\section{Электромагнитные модели в GEANT4 }\label{sec:theory/models}


Для моделирования электромагнитных процессов в GEANT4 используются специальный конструкторы, которые надо добавить в физический лист моделирования. Эти конструкторы как правило отличаются моделями используемыми в конкретных диапазонах энергий, а так же настройками связанными с точностью численного моделирования. В таблице приведены физические модели используемые в различных моделях для инересующих нас частиц.

%EmStandartOptx, PENELOPA, Livermore
%
%\subsection{PENELOPA}
%Для расчета сечений используется и экспериментальные данные, и аналитические формулы.Описывает процессы для фотонов, электронов и позитронов: рэлеевское рассеяние, комптон-эффект, тормозное излучение, фотоэффект, рождение электрон-позитронных пар гаммой, ионизация (в разработке), аннигиляция позитрона (в разработке)
%Рекомендованные энергетические пределы: 100 эВ – 1 ГэВ
%Рассматриваются тормозное излучение и ионизация для позитрона, а также его аннигиляция
%
%\subsection{Livermore}
%Сечение рассчитывается на основе экспериментальных данных
%Описывает процессы для фотонов, электронов, ионов и адронов: рэлеевское рассеяние, комптон-эффект, тормозное излучение, фотоэффект, рождение электрон-позитронных пар гаммой, ионизация, флюоресценция, электронная эмиссия Ожэ возбужденных атомов
%Рекомендованные энергетические пределы: 250 эВ – 100 ГэВ
%
%- Рэлеевское рассеяние ~ 10 эВ
%
%- Комптон-эффект ~ 250 эВ
%
%- Тормозное излучение ~ 10 эВ
%
%- Ионизация ~ 100 эВ
%
%- Фотоэффект ~ 10 эВ
%
%- Рождение электрон-позитронных пар гаммой ~ 1 МэВ
%
%Не учитываются позитроны (кроме рождения электрон-позитронных пар)
%
%\subsection{}
\section{Электрическое поле в GEANT4 }\label{sec:theory/efield}
Глава ~\ref{ch:thunderstorm} посвящена моделированию лавин релятивистских убегающих электронов в электрическом поле грозовых облаков, поэтому в данном разделе описано как подключается электрическое поле в симуляции. Для включение электрического поля необходимо: 
\begin{itemize}
    \item Определить распределение поля: можно установить однородное поле с заданным вектором напряжённости или задать произвольное поле, реализовав объект который принимает координата точки и время и должен вернуть вектор напряжённости поля.
    \item Задать классы ответственные за решения уравнения движения в этом поле: класс описывающий уравнение движения, указать число переменных, класс интегрирующий уравнение движения, класс контролирующий погрешность вычислений интеграла движения и класс рассчитывающий траекторию движения( который также проводи вычисляет поправку на кривизну траектории) . В данной работе для интегрирования уравнения движения в зависимости от версии GEANT4 использовались,или класс \textit{G4ClassicalRK4} классический метод Рунге-Кутта 4-го порядка~\cite{fedorenko1994} или класс \textit{G4DormandPrince745} реализующий метод Рунге-Кутта 5-го порядка~\cite{dormand1980family}. 
    \item Зарегистрировать поле в менеджере полей и подключить этот менеджер к геометрическому объему.
\end{itemize}

Далее приводится пример кода используемого для подключения электрического поля:
\begin{lstlisting}[language=C++]
 // Задаем однородное поле
 G4ElectricField *fEMfield = new G4UniformElectricField(
        G4ThreeVector(0.0, 0.0, 200.0*(kilovolt/meter)));
 // Уравение движение учитывающее силу Кулона и силу Лоренца
 auto *equation = new G4EqMagElectricField(fEMfield);
 G4int nvar = 8;
 // Выбираем интегратор, как альтенативу можно использовать G4ClassicalRK4
 auto fStepper = new G4DormandPrince745(equation, nvar);
 auto *fieldManager = new G4FieldManager();
 // Устанавливаем менеджер полей для геометричекого объема
 fieldVolume->SetFieldManager(fieldManager, true); 
 fieldManager->SetDetectorField(fEMfield);
 G4double fMinStep = 0.01 * mm;  // Минимальный шаг
 // Контроль ошибок интегрирования
 auto integrationDriver = new G4MagInt_Driver(
        fMinStep,
        fStepper,
        fStepper->GetNumberOfVariables()
        );
 // Поиск корретной траектории движения
 auto fChordFinder = new G4ChordFinder(integrationDriver);
 fieldManager->SetChordFinder(fChordFinder);
\end{lstlisting}
